# Updating mquickjs to the Latest Version

This document explains how to update the mquickjs library to the latest upstream version.

## Quick Start

```bash
rake update_mquickjs
```

This will automatically download and update all necessary files from the [upstream mquickjs repository](https://github.com/bellard/mquickjs).

## What Gets Updated

The rake task automatically:

1. **Clones** the latest mquickjs from GitHub
2. **Copies** all C and H files except Ruby-specific and excluded files
3. **Creates a backup** of existing files (with timestamp)
4. **Detects new files** automatically (future-proof)
5. **Warns about removed files** if any exist locally but not upstream

## Files Updated from Upstream

The task copies ALL `.c` and `.h` files from upstream, EXCEPT:

### Excluded Files (Ruby-specific)
- `mquickjs_ext.c` - Ruby native extension binding
- `mquickjs_wrapper.h` - Ruby-specific wrapper
- `extconf.rb` - Ruby extension build configuration

### Excluded Files (Not needed)
- `mqjs.c` - REPL implementation (not needed for embedding)
- `readline.c`, `readline.h`, `readline_tty.c`, `readline_tty.h` - REPL dependencies
- `example.c`, `example_stdlib.c` - Example files

### Generated Files (Recreated during build)
- `mquickjs_atom.h` - Generated by `mqjs_stdlib -a` during build
- `mqjs_stdlib.h` - Generated by `mqjs_stdlib` during build

These are automatically regenerated when you run `rake compile` (see `ext/mquickjs/extconf.rb`).

## Files Typically Updated

Core engine files that get updated:
- `mquickjs.c`, `mquickjs.h` - Main QuickJS engine
- `mquickjs_priv.h` - Private definitions
- `mquickjs_opcode.h` - VM opcodes
- `mquickjs_build.c`, `mquickjs_build.h` - Build tool for stdlib
- `cutils.c`, `cutils.h` - Utility functions
- `dtoa.c`, `dtoa.h` - Double-to-ASCII conversion
- `libm.c`, `libm.h` - Math library
- `list.h` - List data structure
- `mqjs_stdlib.c` - JavaScript standard library source
- `softfp_template.h`, `softfp_template_icvt.h` - Floating-point emulation

**Plus any new files added by upstream** (automatically included!).

## Full Update Process

1. **Update the files**:
   ```bash
   rake update_mquickjs
   ```

2. **Review the changes**:
   ```bash
   git diff ext/mquickjs/
   ```

3. **Clean and rebuild**:
   ```bash
   rake clean
   rake compile
   ```

4. **Run tests**:
   ```bash
   rake test
   ```

5. **Run benchmarks** (optional but recommended):
   ```bash
   rake benchmark
   ```

6. **If everything works**, commit and cleanup:
   ```bash
   git add ext/mquickjs/
   git commit -m "Update mquickjs to latest upstream version"
   rm -rf ext/mquickjs/backup_*
   ```

## If Something Goes Wrong

### Restore from backup

If the update breaks something, the task creates a timestamped backup directory:

```bash
# Find the backup
ls -la ext/mquickjs/backup_*

# Restore all files
cp ext/mquickjs/backup_YYYYMMDD_HHMMSS/* ext/mquickjs/

# Rebuild
rake clean compile
```

### Check for API changes

If tests fail after updating, check for:

1. **Changed C API** - Review `mquickjs.h` for API changes
2. **Changed opcodes** - Check `mquickjs_opcode.h`
3. **New required files** - The task will report "Added (new)" files
4. **Removed files** - The task will warn about files that exist locally but not upstream

You may need to update `ext/mquickjs/mquickjs_ext.c` if the C API changed.

## Manual Update (Alternative)

If you prefer manual control:

1. Clone mquickjs:
   ```bash
   git clone https://github.com/bellard/mquickjs.git /tmp/mquickjs
   ```

2. Copy files manually:
   ```bash
   # Copy core files (adjust list as needed)
   cp /tmp/mquickjs/*.{c,h} ext/mquickjs/

   # Don't overwrite Ruby-specific files
   git checkout ext/mquickjs/mquickjs_ext.c
   git checkout ext/mquickjs/mquickjs_wrapper.h
   git checkout ext/mquickjs/extconf.rb
   ```

3. Rebuild:
   ```bash
   rake clean compile test
   ```

## Checking Upstream Version

To see what changed upstream before updating:

```bash
# Visit the GitHub repository
open https://github.com/bellard/mquickjs

# Or check the commit log
git clone https://github.com/bellard/mquickjs.git /tmp/mquickjs
cd /tmp/mquickjs
git log --oneline
```

## Troubleshooting

### Build fails after update

1. Check if upstream added new dependencies
2. Review the error message from the compiler
3. Check if the C API changed in `mquickjs.h`
4. Restore from backup and investigate incrementally

### Tests fail after update

1. Check for JavaScript engine behavior changes
2. Review changes in `mquickjs.c` related to memory management
3. Check for changes in error handling
4. Run individual tests to isolate the issue

### New compiler warnings

1. Review the warnings - they may indicate real issues
2. Check if upstream fixed any undefined behavior
3. Consider updating compiler flags in `extconf.rb` if needed

## Future-Proofing

This rake task is designed to be **future-proof**:

- ✅ Automatically detects new upstream files
- ✅ Warns about removed files
- ✅ Preserves Ruby-specific customizations
- ✅ Creates timestamped backups
- ✅ No hardcoded file lists to maintain

If upstream adds new files, they'll be automatically included!
